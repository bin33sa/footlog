<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fl.mapper.MyTeamMapper">

	<select id="listMyTeam" parameterType="Long" resultType="com.fl.model.TeamDTO">
	    SELECT t.team_code, t.team_name, t.emblem_image
	    FROM team t
	    JOIN member_team tm ON t.team_code = tm.team_code
	    WHERE tm.member_code = #{member_code}
	    ORDER BY t.team_name
	</select>

	<select id="readTeamInfo" parameterType="Long" resultType="com.fl.model.TeamDTO">
	    SELECT 
	        team_code, 
	        team_name, 
	        team_url,
	        contact_number,
	        region, 
	        description,      created_at,
	        emblem_image,
	        intro_video_url,
	        member_count
	    FROM team
	    WHERE team_code = #{team_code}
	</select>

	<select id="readMyTeamStatus" parameterType="map" resultType="com.fl.model.TeamMemberDTO">
	    SELECT 
	        team_code, 
	        member_code, 
	        role_level, 
	        position, 
	        back_number, 
	        profile_image,
	        reg_date AS join_date
	    FROM member_team
	    WHERE team_code = #{team_code} 
	      AND member_code = #{member_code}
	</select>
	
	<update id="updateTeamMember" parameterType="com.fl.model.TeamMemberDTO">
		UPDATE member_team
		SET profile_image = #{profile_image}
		WHERE team_code = #{team_code} 
		  AND member_code = #{member_code}
	</update>
	
	<update id="updateTeamInfo" parameterType="com.fl.model.TeamDTO">
	    UPDATE team
	    SET 
	        team_name = #{team_name},
	        description = #{description},
	        region = #{region},
	        emblem_image = #{emblem_image}
	        WHERE team_code = #{team_code}
	</update>

	<delete id="deleteMyTeamHistory" parameterType="map">
	    DELETE FROM member_team 
	    WHERE team_code = #{team_code} AND member_code = #{member_code}
	</delete>
	
	<update id="updateTeamMemberCountDown" parameterType="Long">
		UPDATE team SET member_count = member_count - 1 WHERE team_code = #{team_code}
	</update>
	
	<update id="updateTeamMemberCountUp" parameterType="Long">
		UPDATE team SET member_count = member_count + 1 WHERE team_code = #{team_code}
	</update>


	<select id="listTeamMember" parameterType="map" resultType="com.fl.model.TeamMemberDTO">
	    SELECT * FROM (
	        SELECT ROWNUM rnum, tb.* FROM (
	            SELECT 
	                tm.member_code, 
	                m.member_name,  
	                m.member_id,    
	                tm.role_level,
	                tm.position,
	                tm.back_number,
	                tm.profile_image,  TO_CHAR(tm.reg_date, 'YYYY-MM-DD') AS join_date
	                
	            FROM member_team tm
	            JOIN member m ON tm.member_code = m.member_code
	            WHERE tm.team_code = #{team_code} 
	            
	            <if test="keyword != null and keyword != ''">
	                AND (m.member_name LIKE '%' || #{keyword} || '%')
	            </if>
	            ORDER BY tm.role_level DESC, m.member_name ASC
	        ) tb WHERE ROWNUM &lt;= #{end}
	    ) WHERE rnum &gt;= #{start}
	</select>
	
	<select id="dataCountTeamMember" parameterType="map" resultType="Integer">
		SELECT COUNT(*)
		FROM team_member tm
		JOIN member m ON tm.member_code = m.member_code
		WHERE tm.team_code = #{team_code} AND tm.status = 1
		<if test="keyword != null and keyword != ''">
			AND (m.user_name LIKE '%' || #{keyword} || '%')
		</if>
	</select>

	<update id="updateMemberRole" parameterType="map">
	    UPDATE member_team
	    <set>
	        <if test="role_level != null and role_level != ''">
	            role_level = #{role_level},
	        </if>
	        <if test="position != null and position != ''">
	            position = #{position},
	        </if>
	        <if test="back_number != null and back_number != ''">
	            back_number = #{back_number},
	        </if>
	    </set>
	    WHERE team_code = #{team_code} 
	      AND member_code = #{member_code}
	</update>

	<delete id="deleteTeamMember" parameterType="map">
	    DELETE FROM member_team 
	    WHERE team_code = #{team_code} AND member_code = #{member_code}
	</delete>


	<select id="listJoinRequest" parameterType="Long" resultType="com.fl.model.JoinRequestDTO">
	    SELECT 
	        r.member_code, 
	        r.team_code, 
	        r.status, 
	        TO_CHAR(r.created_at, 'YYYY-MM-DD') as created_at,
	        
	        m.member_name AS user_name, 
	        m.member_id AS user_id
	    FROM join_request r
	    JOIN member m ON r.member_code = m.member_code
	    WHERE r.team_code = #{team_code}
	    ORDER BY r.created_at ASC
	</select>

	<insert id="insertTeamMemberFromRequest" parameterType="com.fl.model.TeamMemberDTO">
		INSERT INTO member_team(member_code, team_code, role_level, position)
		VALUES (#{member_code}, #{team_code}, 1, #{position})
	</insert>
	
	<delete id="deleteJoinRequest" parameterType="map">
		DELETE FROM join_request 
		WHERE team_code = #{team_code} AND member_code = #{member_code}
	</delete>


	<insert id="insertSchedule" parameterType="com.fl.model.ScheduleDTO">
		INSERT INTO team_schedule(schedule_code, team_code, member_code, subject, start_date, end_date, color, place, memo, reg_date)
		VALUES (team_schedule_seq.NEXTVAL, #{team_code}, #{member_code}, #{subject}, #{start_date}, #{end_date}, #{color}, #{place}, #{memo}, SYSDATE)
	</insert>

	<select id="listMonthSchedule" parameterType="map" resultType="com.fl.model.ScheduleDTO">
		SELECT schedule_code, subject, start_date, end_date, color, place
		FROM team_schedule
		WHERE team_code = #{team_code}
		  AND start_date &gt;= #{startStr} AND start_date &lt;= #{endStr}
	</select>
	
	<update id="updateSchedule" parameterType="com.fl.model.ScheduleDTO">
		UPDATE team_schedule
		SET subject=#{subject}, start_date=#{start_date}, end_date=#{end_date}, color=#{color}, place=#{place}, memo=#{memo}
		WHERE schedule_code=#{schedule_code}
	</update>

	<delete id="deleteSchedule" parameterType="Long">
		DELETE FROM team_schedule WHERE schedule_code = #{schedule_code}
	</delete>


	<insert id="insertVote" parameterType="com.fl.model.VoteDTO">
		<selectKey keyProperty="board_vote_code" resultType="Long" order="BEFORE">
			SELECT team_vote_seq.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO team_vote(board_vote_code, team_code, member_code, title, content, start_date, end_date, status, view_count, created_at)
		VALUES (#{board_vote_code}, #{team_code}, #{member_code}, #{title}, #{content}, #{start_date}, #{end_date}, 0, 0, SYSDATE)
	</insert>

	<insert id="insertVoteOption" parameterType="com.fl.model.VoteOptionDTO">
		INSERT INTO team_vote_option(option_code, board_vote_code, content)
		VALUES (team_vote_option_seq.NEXTVAL, #{board_vote_code}, #{content})
	</insert>

	<select id="listVote" parameterType="map" resultType="com.fl.model.VoteDTO">
		SELECT v.board_vote_code, v.title, v.end_date, v.status, v.view_count,
		       m.user_name AS writer_name,
		       TO_CHAR(v.created_at, 'YYYY-MM-DD') AS created_at,
		       /* 참여자 수 */
		       (SELECT COUNT(DISTINCT member_code) FROM team_vote_history WHERE board_vote_code = v.board_vote_code) AS vote_count,
		       /* 내 투표 여부 */
		       NVL((SELECT 1 FROM team_vote_history 
		            WHERE board_vote_code = v.board_vote_code AND member_code = #{member_code} AND ROWNUM = 1), 0) AS my_vote_status
		FROM team_vote v
		JOIN member m ON v.member_code = m.member_code
		WHERE v.team_code = #{team_code}
		ORDER BY v.status ASC, v.end_date ASC
	</select>

	<select id="readVote" parameterType="map" resultType="com.fl.model.VoteDTO">
		SELECT v.board_vote_code, v.title, v.content, v.view_count,
		       TO_CHAR(v.start_date, 'YYYY-MM-DD HH24:MI') as start_date,
		       TO_CHAR(v.end_date, 'YYYY-MM-DD HH24:MI') as end_date,
		       m.user_name AS writer_name,
		       NVL((SELECT 1 FROM team_vote_history WHERE board_vote_code = v.board_vote_code AND member_code = #{member_code} AND ROWNUM = 1), 0) AS my_vote_status
		FROM team_vote v
		JOIN member m ON v.member_code = m.member_code
		WHERE v.board_vote_code = #{board_vote_code}
	</select>

	<select id="listVoteOptions" parameterType="map" resultType="com.fl.model.VoteOptionDTO">
		SELECT option_code, board_vote_code, content,
		       /* 이 옵션의 득표수 */
		       (SELECT COUNT(*) FROM team_vote_history WHERE option_code = o.option_code) AS option_count,
		       /* 내가 체크했는지 여부 */
		       NVL((SELECT 1 FROM team_vote_history WHERE option_code = o.option_code AND member_code = #{member_code}), 0) AS is_checked
		FROM team_vote_option o
		WHERE board_vote_code = #{board_vote_code}
		ORDER BY option_code ASC
	</select>

	<insert id="insertVoteHistory" parameterType="map">
		INSERT INTO team_vote_history(history_code, board_vote_code, option_code, member_code)
		VALUES (team_vote_history_seq.NEXTVAL, #{board_vote_code}, #{option_code}, #{member_code})
	</insert>
	
	<select id="checkVoteHistory" parameterType="map" resultType="Integer">
		SELECT COUNT(*) FROM team_vote_history 
		WHERE board_vote_code = #{board_vote_code} AND member_code = #{member_code}
	</select>


	<insert id="insertTeamBoard" parameterType="com.fl.model.TeamBoardDTO">
        INSERT INTO board_team(
            board_team_code, team_code, member_code, title, content, 
            created_at, category, hit_count, video_url
        )
        VALUES (
            board_team_seq.NEXTVAL, #{team_code}, #{member_code}, #{title}, #{content}, 
            SYSDATE, 0, 0, #{video_url, jdbcType=VARCHAR}
        )
    </insert>

    <select id="listTeamBoard" parameterType="map" resultType="com.fl.model.TeamBoardDTO">
        SELECT * FROM (
            SELECT ROWNUM rnum, tb.* FROM (
                SELECT b.board_team_code, b.title, 
                       m.member_name AS user_name,  
                       TO_CHAR(b.created_at, 'YYYY-MM-DD') as created_at, 
                       b.hit_count
                FROM board_team b
                JOIN member m ON b.member_code = m.member_code WHERE b.team_code = #{team_code}
                
                <if test="keyword != null and keyword != ''">
                    AND (
                        <choose>
                            <when test="condition == 'all'">
                                INSTR(title, #{keyword}) &gt; 0 OR INSTR(content, #{keyword}) &gt; 0
                            </when>
                            <when test="condition == 'subject' or condition == 'title'">
                                INSTR(title, #{keyword}) &gt; 0
                            </when>
                            <when test="condition == 'content'">
                                INSTR(content, #{keyword}) &gt; 0
                            </when>
                            <when test="condition == 'userName'">
                                INSTR(m.member_name, #{keyword}) &gt; 0 
                            </when>
                            <when test="condition == 'created_at'">
                                TO_CHAR(b.created_at, 'YYYY-MM-DD') = #{keyword}
                            </when>
                        </choose>
                    )
                </if>
                ORDER BY b.board_team_code DESC
            ) tb WHERE ROWNUM &lt;= #{end}
        ) WHERE rnum &gt;= #{start}
    </select>

    <select id="dataCountTeamBoard" parameterType="map" resultType="Integer">
        SELECT NVL(COUNT(*), 0) 
        FROM board_team b
        JOIN member m ON b.member_code = m.member_code WHERE b.team_code = #{team_code}
        <if test="keyword != null and keyword != ''">
            AND (
                <choose>
                    <when test="condition == 'all'">
                        INSTR(title, #{keyword}) &gt; 0 OR INSTR(content, #{keyword}) &gt; 0
                    </when>
                    <when test="condition == 'subject' or condition == 'title'">
                        INSTR(title, #{keyword}) &gt; 0
                    </when>
                    <when test="condition == 'content'">
                        INSTR(content, #{keyword}) &gt; 0
                    </when>
                    <when test="condition == 'userName'">
                        INSTR(m.member_name, #{keyword}) &gt; 0 
                    </when>
                    <when test="condition == 'created_at'">
                        TO_CHAR(b.created_at, 'YYYY-MM-DD') = #{keyword}
                    </when>
                </choose>
            )
        </if>
    </select>

    <update id="updateHitCount" parameterType="Long">
        UPDATE board_team SET hit_count = hit_count + 1 WHERE board_team_code = #{board_team_code}
    </update>

    <select id="readTeamBoard" parameterType="Long" resultType="com.fl.model.TeamBoardDTO">
        SELECT b.board_team_code, b.team_code, 
               b.member_code, b.title, b.content, b.hit_count, b.category, b.video_url,
               TO_CHAR(b.created_at, 'YYYY-MM-DD HH24:MI:SS') as created_at, 
               m.member_name AS user_name 
        FROM board_team b
        JOIN member m ON b.member_code = m.member_code WHERE board_team_code = #{board_team_code}
    </select>

    <update id="updateTeamBoard" parameterType="com.fl.model.TeamBoardDTO">
        UPDATE board_team SET title = #{title}, content = #{content}
        WHERE board_team_code = #{board_team_code}
    </update>

    <delete id="deleteTeamBoard" parameterType="Long">
        DELETE FROM board_team WHERE board_team_code = #{board_team_code}
    </delete>

    <select id="preReadTeamBoard" parameterType="map" resultType="com.fl.model.TeamBoardDTO">
        SELECT board_team_code, title
        FROM board_team b
        JOIN member m ON b.member_code = m.member_code WHERE team_code = #{team_code} 
          AND board_team_code &gt; #{board_team_code}
          <if test="keyword != null and keyword != ''">
              AND (
                 <choose>
                    <when test="condition == 'all'">
                        INSTR(title, #{keyword}) &gt; 0 OR INSTR(content, #{keyword}) &gt; 0
                    </when>
                    <when test="condition == 'subject' or condition == 'title'">
                        INSTR(title, #{keyword}) &gt; 0
                    </when>
                    <when test="condition == 'content'">
                        INSTR(content, #{keyword}) &gt; 0
                    </when>
                    <when test="condition == 'userName'">
                        INSTR(m.member_name, #{keyword}) &gt; 0 
                    </when>
                    <when test="condition == 'created_at'">
                        TO_CHAR(b.created_at, 'YYYY-MM-DD') = #{keyword}
                    </when>
                 </choose>
              )
          </if>
        ORDER BY board_team_code ASC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <select id="nextReadTeamBoard" parameterType="map" resultType="com.fl.model.TeamBoardDTO">
        SELECT board_team_code, title
        FROM board_team b
        JOIN member m ON b.member_code = m.member_code WHERE team_code = #{team_code} 
          AND board_team_code &lt; #{board_team_code}
          <if test="keyword != null and keyword != ''">
              AND (
                 <choose>
                    <when test="condition == 'all'">
                        INSTR(title, #{keyword}) &gt; 0 OR INSTR(content, #{keyword}) &gt; 0
                    </when>
                    <when test="condition == 'subject' or condition == 'title'">
                        INSTR(title, #{keyword}) &gt; 0
                    </when>
                    <when test="condition == 'content'">
                        INSTR(content, #{keyword}) &gt; 0
                    </when>
                    <when test="condition == 'userName'">
                        INSTR(m.member_name, #{keyword}) &gt; 0 
                    </when>
                    <when test="condition == 'created_at'">
                        TO_CHAR(b.created_at, 'YYYY-MM-DD') = #{keyword}
                    </when>
                 </choose>
              )
          </if>
        ORDER BY board_team_code DESC
        FETCH FIRST 1 ROWS ONLY
    </select>
	
	<select id="readMemberRoleLevel" parameterType="map" resultType="Integer">
        SELECT role_level
        FROM member_team
        WHERE team_code = #{team_code} AND member_code = #{member_code}
    </select>
	
	<insert id="insertGallery" parameterType="com.fl.model.GalleryDTO">
		<selectKey keyProperty="gallery_code" resultType="Long" order="BEFORE">
			SELECT team_gallery_seq.NEXTVAL FROM DUAL
		</selectKey>
	
		INSERT INTO team_gallery(gallery_code, team_code, member_code, title, content, title_image, view_count, created_at)
		VALUES (#{gallery_code}, #{team_code}, #{member_code}, #{title}, #{content}, #{title_image, jdbcType=VARCHAR}, 0, SYSDATE)
	</insert>

	<select id="galleryDataCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*), 0) 
		FROM team_gallery 
		WHERE team_code = #{team_code}
	</select>

	<select id="listGallery" parameterType="map" resultType="com.fl.model.GalleryDTO">
		SELECT 
			g.gallery_code, 
			g.team_code, 
			g.member_code, 
			g.title, 
			g.title_image, 
			g.view_count,
			TO_CHAR(g.created_at, 'YYYY-MM-DD') AS created_at,
			m.member_name,       
			tm.profile_image,
			/* 댓글수, 좋아요수 서브쿼리 */
			(SELECT COUNT(*) FROM team_gallery_comment WHERE gallery_code = g.gallery_code) AS reply_count,
			(SELECT COUNT(*) FROM team_gallery_like WHERE gallery_code = g.gallery_code) AS like_count

		FROM team_gallery g
		JOIN member m ON g.member_code = m.member_code
		LEFT JOIN member_team tm ON g.team_code = tm.team_code AND g.member_code = tm.member_code
		
		WHERE g.team_code = #{team_code}
		ORDER BY g.gallery_code DESC
		OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
	</select>

	<select id="readGallery" parameterType="Long" resultType="com.fl.model.GalleryDTO">
		SELECT 
			g.gallery_code, g.team_code, g.member_code, 
			g.title, g.content, g.title_image, g.view_count, 
			TO_CHAR(g.created_at, 'YYYY-MM-DD HH24:MI:SS') AS created_at,
			m.member_name, m.member_id,
			tm.profile_image,
			(SELECT COUNT(*) FROM team_gallery_comment WHERE gallery_code = g.gallery_code) AS reply_count,
			(SELECT COUNT(*) FROM team_gallery_like WHERE gallery_code = g.gallery_code) AS like_count
			
		FROM team_gallery g
		JOIN member m ON g.member_code = m.member_code
		LEFT JOIN member_team tm ON g.team_code = tm.team_code AND g.member_code = tm.member_code
		WHERE g.gallery_code = #{gallery_code}
	</select>
	
	<update id="updateGalleryHitCount" parameterType="Long">
		UPDATE team_gallery SET view_count = view_count + 1 WHERE gallery_code = #{gallery_code}
	</update>

	<update id="updateGallery" parameterType="com.fl.model.GalleryDTO">
		UPDATE team_gallery
		SET title = #{title},
			content = #{content}
			<if test="title_image != null and title_image != ''">
				, title_image = #{title_image}
			</if>
		WHERE gallery_code = #{gallery_code}
	</update>

	<delete id="deleteGallery" parameterType="Long">
		DELETE FROM team_gallery WHERE gallery_code = #{gallery_code}
	</delete>


	<insert id="insertGalleryFile" parameterType="com.fl.model.FileDTO">
		INSERT INTO team_gallery_file(file_code, gallery_code, file_server_name, file_origin_name)
		VALUES (team_gallery_file_seq.NEXTVAL, #{gallery_code}, #{file_server_name}, #{file_name})
	</insert>

	<select id="listGalleryFiles" parameterType="Long" resultType="com.fl.model.FileDTO">
		SELECT 
			file_code AS file_id,
			gallery_code,
			file_server_name,
			file_origin_name AS file_name
		FROM team_gallery_file
		WHERE gallery_code = #{gallery_code}
	</select>


	<insert id="insertReply" parameterType="com.fl.model.BoardReplyDTO">
		INSERT INTO team_gallery_comment(comment_code, gallery_code, member_code, content, created_at)
		VALUES (team_gallery_comment_seq.NEXTVAL, #{gallery_code}, #{member_code}, #{content}, SYSDATE)
	</insert>

	<select id="listReply" parameterType="map" resultType="com.fl.model.BoardReplyDTO">
		SELECT 
			c.comment_code AS comment_id,  
			c.gallery_code,
			c.member_code,
			c.content,
			TO_CHAR(c.created_at, 'YYYY-MM-DD HH24:MI') AS created_at,
			m.member_name,
			tm.profile_image               
		FROM team_gallery_comment c
		JOIN member m ON c.member_code = m.member_code
		LEFT JOIN member_team tm ON m.member_code = tm.member_code AND tm.team_code = #{team_code}
		WHERE c.gallery_code = #{gallery_code}
		ORDER BY c.comment_code DESC
		OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
	</select>

	<select id="replyCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*), 0) FROM team_gallery_comment WHERE gallery_code = #{gallery_code}
	</select>

	<delete id="deleteReply" parameterType="map">
		DELETE FROM team_gallery_comment 
		WHERE comment_code = #{comment_id}
	</delete>
	
	<insert id="insertGalleryLike" parameterType="map">
		INSERT INTO team_gallery_like(gallery_code, member_code)
		VALUES (#{gallery_code}, #{member_code})
	</insert>

	<delete id="deleteGalleryLike" parameterType="map">
		DELETE FROM team_gallery_like
		WHERE gallery_code = #{gallery_code} AND member_code = #{member_code}
	</delete>

	<select id="checkGalleryLike" parameterType="map" resultType="Integer">
		SELECT COUNT(*) 
		FROM team_gallery_like
		WHERE gallery_code = #{gallery_code} AND member_code = #{member_code}
	</select>
	
	<select id="countGalleryLike" parameterType="Long" resultType="Integer">
		SELECT COUNT(*) 
		FROM team_gallery_like
		WHERE gallery_code = #{gallery_code}
	</select>
	
	<update id="updateReply" parameterType="map">
	    UPDATE team_gallery_comment 
	    SET content = #{content}
	    WHERE comment_code = #{comment_id} AND member_code = #{member_code}
	</update>
	
	<delete id="deleteGalleryFiles" parameterType="Long">
        DELETE FROM team_gallery_file WHERE gallery_code = #{gallery_code}
    </delete>
</mapper>