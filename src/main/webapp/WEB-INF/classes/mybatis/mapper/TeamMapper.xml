<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fl.mapper.TeamMapper">

    <sql id="searchData">
        <if test="keyword != null and keyword != ''">
            AND (
                INSTR(t.team_name, #{keyword}) &gt; 0 
                OR 
                INSTR(t.region, #{keyword}) &gt; 0
            )
        </if>
    </sql>

    <select id="listTeam" parameterType="map" resultType="com.fl.model.TeamDTO">
        SELECT 
            t.team_code, 
            t.team_name, 
            t.region, 
            t.emblem_image, 
            TO_CHAR(t.created_at, 'YYYY-MM-DD') AS created_at,
            (SELECT COUNT(*) FROM member_team mt WHERE mt.team_code = t.team_code) AS member_count,
            (SELECT COUNT(*) FROM like_team lt WHERE lt.team_code = t.team_code) AS like_count,
            (SELECT m.member_name 
             FROM member m 
             JOIN member_team mt ON m.member_code = mt.member_code 
             WHERE mt.team_code = t.team_code AND mt.role_level = 10) AS leader_name      
        FROM team t
        WHERE t.status = 1  
        
        <include refid="searchData"/>
        
        ORDER BY
        <choose>
            <when test="sort == '1'"> member_count DESC, t.created_at DESC
            </when>
            <when test="sort == '2'"> like_count DESC, t.created_at DESC
            </when>
            <otherwise> t.created_at DESC
            </otherwise>
        </choose>
        
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>
    
    <select id="teamCount" parameterType="map" resultType="Integer">
        SELECT COUNT(*) FROM team t
        WHERE t.status = 1
        <include refid="searchData"/>
    </select>
    
    <select id="readTeam" parameterType="map" resultType="com.fl.model.TeamDTO">
	    SELECT 
	        t.team_code, 
	        t.team_name, 
	        t.region, 
	        t.description, 
	        t.contact_number, 
	        t.intro_video_url,
	        t.emblem_image, 
	        t.status,  TO_CHAR(t.created_at, 'YYYY-MM-DD') AS created_at, 
	        (SELECT COUNT(*) FROM member_team WHERE team_code = t.team_code) AS member_count,
	        (SELECT COUNT(*) FROM like_team WHERE team_code = t.team_code) AS like_count,
	        (SELECT m.member_name 
	         FROM member m 
	         JOIN member_team mt ON m.member_code = mt.member_code 
	         WHERE mt.team_code = t.team_code AND mt.role_level = 10) AS leader_name,
	         
	        <choose>
	            <when test="member_code != null and member_code != 0">
	                NVL((SELECT 1 FROM like_team lt 
	                     WHERE lt.team_code = t.team_code AND lt.member_code = #{member_code}), 0)
	            </when>
	            <otherwise>0</otherwise>
	        </choose> AS user_liked
	        
	    FROM team t
	    WHERE t.team_code = #{team_code}
	</select>
    
    <select id="readMyTeam" parameterType="Long" resultType="com.fl.model.TeamDTO">
	    SELECT 
        t.team_code, 
        t.team_name, 
        t.emblem_image, 
        t.region,
        mt.role_level  FROM team t
	    JOIN member_team mt ON t.team_code = mt.team_code
	    WHERE mt.member_code = #{member_code}
	</select>	
    
    <insert id="insertTeamLike" parameterType="map">
        INSERT INTO like_team (team_code, member_code)
        VALUES (#{team_code}, #{member_code})
    </insert>

    <delete id="deleteTeamLike" parameterType="map">
        DELETE FROM like_team 
        WHERE team_code = #{team_code} AND member_code = #{member_code}
    </delete>
    
    <select id="teamLikeCount" parameterType="Long" resultType="Integer">
        SELECT COUNT(*) FROM like_team WHERE team_code = #{team_code}
    </select>

    <insert id="insertTeam" parameterType="com.fl.model.TeamDTO">
        <selectKey keyProperty="team_code" resultType="long" order="BEFORE">
            SELECT seq_team.NEXTVAL FROM dual
        </selectKey>
        INSERT INTO team (team_code, team_name, region, description, emblem_image, contact_number, intro_video_url, team_url, created_at) 
        VALUES (#{team_code}, #{team_name}, #{region}, #{description}, #{emblem_image, jdbcType=VARCHAR}, #{contact_number}, #{intro_video_url, jdbcType=VARCHAR}, 'pending', SYSDATE)
    </insert>

    <insert id="insertTeamMember" parameterType="map">
        INSERT INTO member_team (team_code, member_code, role_level, position, reg_date) 
        VALUES (#{team_code}, #{member_code}, #{role_level}, #{position}, SYSDATE)
    </insert>	
    
    <update id="deleteTeam" parameterType="Long">
	    UPDATE team 
	    SET 
	        status = 0, 
	        deleted_at = SYSDATE  WHERE team_code = #{team_code}
	</update>

    <select id="checkJoinStatus" parameterType="map" resultType="Integer">
	    SELECT 
	        CASE
	            WHEN EXISTS ( 
	                SELECT 1 FROM member_team 
	                WHERE member_code = #{member_code} AND team_code = #{team_code}
	            ) THEN 15 
	            
	            WHEN EXISTS (
	                SELECT 1 FROM join_request 
	                WHERE member_code = #{member_code} AND team_code = #{team_code} AND status = 1
	            ) THEN 1
	         
	            ELSE 0 
	        END 
	    FROM dual
	</select>
	
	<select id="isLeader" parameterType="map" resultType="Integer">
		SELECT COUNT(*) 
	    FROM member_team 
	    WHERE team_code = #{team_code} 
	      AND member_code = #{member_code} 
	      AND role_level = 10
	</select>
	
	<insert id="insertJoinRequest" parameterType="map">
        INSERT INTO join_request (team_code, member_code, status, created_at)
        VALUES (#{team_code}, #{member_code}, 1, SYSDATE)
    </insert>

</mapper>