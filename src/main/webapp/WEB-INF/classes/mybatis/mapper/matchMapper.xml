<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fl.mapper.MatchMapper">
	
	<sql id="where-list">
	    <if test="region != null and region != '' and region != 'all'">
	        AND s.region = #{region}
	    </if>
    	 <if test="matchDate!=null and matchDate!=''">
                AND TO_CHAR(m.match_date, 'YYYY-MM-DD') = #{matchDate}
         </if>
         
   		 <if test="kwd != null and kwd != ''">
           
                AND ( INSTR(m.title, #{kwd}) &gt; 0
                   OR INSTR(ht.team_name, #{kwd}) &gt; 0 
                   OR INSTR(stadium_name, #{kwd}) &gt; 0 )
         </if>
</sql>
	
	<!-- 글 등록 -->
	<insert id="insertMatch" parameterType="com.fl.model.MatchDTO">
	    INSERT INTO match_post
	        (match_code,home_code,away_code,match_date,status,title,content,created_at,view_count, matchType, gender, fee,member_code,matchLevel,stadium_code)
	    VALUES
	    (seq_match_post.NEXTVAL, #{home_code},NULL,
	     TO_DATE(#{match_date}, 'YYYY-MM-DD"T"HH24:MI'), '모집중',#{title},#{content},SYSDATE,
	      0,#{matchType},#{gender},#{fee},#{member_code},#{matchLevel},#{stadiumCode})
	</insert>
	
	<!-- 글 수정 -->
	<update id="updateMatch">
		UPDATE match_post SET title=#{title}, content=#{content}, match_date=#{match_date}, status=#{status}, 
		 		matchType=#{matchType}, gender=#{gender},fee=#{fee}, matchLevel=#{matchLevel}, stadium_code=#{stadium_code}
		WHERE match_code=#{match_code}
	</update>
	
	<!-- 글 삭제 -->
	<delete id="deleteMatch" parameterType="map">
		DELETE FROM match_post 
		<where>
			<choose>
				<when test="ROLE_LEVEL>=5">
					match_code=#{match_code}
				</when>
				<otherwise>
					match_code=#{match_code} AND member_code=#{member_code}
				</otherwise>
			</choose>
		</where>
	</delete>
	
	<!-- 글 개수 -->
	<select id="dataCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*), 0)
	    FROM match_post m  
	     JOIN team ht ON ht.team_code = m.home_code      
	     JOIN stadium s ON s.stadium_code = m.stadium_code 
	
	   <where>
	      <include refid="where-list"/>
	    </where>

	</select>

	<!-- 매치 리스트 -->
	<select id="listMatch" parameterType="map" resultType="com.fl.model.MatchDTO">
		SELECT m.match_code,ht.team_name AS home_team_name,at.team_name AS away_team_name,
		      TO_CHAR(match_date,'YYYY-MM-DD HH24:MI') AS match_date,status,title,content,view_count,
		      matchType,gender,fee,m.member_code, s.stadium_name AS stadiumName,s.region AS region, matchLevel, m.stadium_code AS stadiumCode
		FROM match_post m
		JOIN team ht ON ht.team_code = m.home_code
		JOIN stadium s ON s.stadium_code = m.stadium_code
		LEFT JOIN team at ON at.team_code = m.away_code
		<where>
			<include refid="where-list"/>
		</where>
		ORDER BY m.match_date
		OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
	</select>
	
	<!-- 팀코드 가져오기 -->
	<select id="findById" parameterType="Long" resultType="com.fl.model.MatchDTO">
		SELECT m.match_code,ht.team_name AS home_team_name,TO_CHAR(m.match_date, 'YYYY-MM-DD HH24:MI') AS match_date, m.status,m.title, 
		m.content, m.fee,s.stadium_name AS stadiumName, s.region AS region, matchType, gender, matchLevel
		FROM match_post m
		JOIN team ht ON ht.team_code = m.home_code
		JOIN stadium s ON s.stadium_code = m.stadium_code
		LEFT JOIN team at ON at.team_code = m.away_code
		WHERE m.match_code = ${match_code}
	</select>
	
	
	<!-- 내 팀 매치 리스트 -->
	<select id="listMyMatch" parameterType="map" resultType="com.fl.model.MatchDTO">
		SELECT match_code,home_code,away_code,match_date,status,title,content,view_count,matchType,gender,fee,member_code
		FROM match_post m
		JOIN team t ON t.team_code =(m.home_code || m.away_code)
		WHERE m.member_code = #{member_code}
	</select>
	
	<select id="getUserTeamCode" parameterType="Long" resultType="Long">
    SELECT team_code 
    FROM member_team  WHERE member_code = #{member_code}
    </select>
	
</mapper>