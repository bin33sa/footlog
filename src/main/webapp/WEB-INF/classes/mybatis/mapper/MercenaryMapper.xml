<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fl.mapper.MercenaryMapper">
	

    <select id="listMercenary" parameterType="map" resultType="com.fl.model.MercenaryDTO">
    SELECT * FROM (
        SELECT ROWNUM rnum, tb.* FROM (
            SELECT p.recruit_id, p.team_code, p.member_code, p.category, p.title, 
                   p.view_count, p.created_at, p.status, m.member_name,
                   t.team_name, 
                   /* 팀이 없는 회원은 등급을 기본값 1로 표시 */
                   NVL(mt.role_level, 1) as role_level 
            FROM MERCENARY_POST p
            JOIN MEMBER m ON p.member_code = m.member_code
            LEFT JOIN TEAM t ON p.team_code = t.team_code
            /* 팀 코드가 있을 때만 등급 조인, 없으면 그냥 지나감 */
            LEFT JOIN member_team mt ON p.member_code = mt.member_code 
                                    AND (p.team_code = mt.team_code OR p.team_code IS NULL)
            <where>
                <if test="category != null and category != ''">
                    AND p.category = #{category}
                </if>
                <if test="kwd != null and kwd != ''">
                    <choose>
                        <when test="schType == 'all'">
                            AND (INSTR(p.title, #{kwd}) &gt; 0 OR INSTR(p.content, #{kwd}) &gt; 0)
                        </when>
                        <otherwise>
                            AND (INSTR(p.${schType}, #{kwd}) &gt; 0)
                        </otherwise>
                    </choose>
                </if>
            </where>
            ORDER BY p.recruit_id DESC
        ) tb WHERE ROWNUM &lt;= #{offset} + #{size}
    ) WHERE rnum &gt; #{offset}
</select>
    
    <insert id="insertMercenary" parameterType="com.fl.model.MercenaryDTO">
        INSERT INTO MERCENARY_POST (
            recruit_id, team_code, match_code, member_code, 
            category, created_at, status, title, content, view_count
        ) VALUES (
            SEQ_MERCENARY_POST.NEXTVAL, 
            #{team_code, jdbcType=BIGINT}, 
            #{match_code, jdbcType=BIGINT}, 
            #{member_code},
            #{category}, 
            SYSDATE, 'RECRUITING', #{title}, #{content}, 0
        )
    </insert>

    <select id="listTeam" parameterType="map" resultType="com.fl.model.MercenaryDTO">
		SELECT t.team_code, t.team_name
		FROM team t 
		JOIN member_team m ON t.team_code = m.team_code
		WHERE m.member_code = #{member_code}
    </select>
	
	<update id="updateMercenary" parameterType="com.fl.model.MercenaryDTO">
		UPDATE Mercenary_post 
    	SET title = #{title}, 
        content = #{content}, 
        team_code = #{team_code}  
        WHERE recruit_id = #{recruit_id} AND member_code = #{member_code}
	</update>
    
    <select id="findById" parameterType="long" resultType="com.fl.model.MercenaryDTO">
        SELECT recruit_id, team_code, match_code, member_code, category,
               created_at, status, title, content, view_count
        FROM mercenary_post
        WHERE recruit_id = #{recruit_id}
    </select>
    
    <delete id="deleteMercenary" parameterType="map">
    DELETE FROM MERCENARY_POST 
    WHERE recruit_id = #{recruit_id} AND member_code = #{member_code}
	</delete>
    
    <select id="dataCount" parameterType="map" resultType="int">
        SELECT COUNT(*) 
        FROM MERCENARY_POST p
        <where>
            <if test="category != null and category != ''">
                AND p.category = #{category}
            </if>
            <if test="kwd != null and kwd != ''">
                AND p.title LIKE '%' || #{kwd} || '%'
            </if>
        </where>   
    </select>

	<insert id="insertReply" parameterType="com.fl.model.MercenaryReplyDTO">
        INSERT INTO comment_mercenary (
            comment_id, parent_comment_id, member_code, recruit_id, content, created_at
        ) VALUES (
            MERCENARY_REPLY_SEQ.NEXTVAL, #{parent_comment_id, jdbcType=INTEGER}, 
            #{member_code}, #{recruit_id}, #{content}, SYSDATE
        )
    </insert>

    <select id="replyCount" parameterType="map" resultType="int">
        SELECT NVL(COUNT(*), 0)
        FROM comment_mercenary
        WHERE recruit_id = #{recruit_id} AND parent_comment_id IS NULL
    </select>

    <select id="listReply" parameterType="map" resultType="com.fl.model.MercenaryReplyDTO">
        SELECT r.comment_id, r.recruit_id, r.member_code, m.member_name, 
               r.content, r.created_at, r.parent_comment_id,
               NVL(a.answerCount, 0) answerCount
        FROM comment_mercenary r
        JOIN MEMBER m ON r.member_code = m.member_code
        LEFT OUTER JOIN (
            SELECT parent_comment_id, COUNT(*) answerCount
            FROM comment_mercenary
            WHERE parent_comment_id IS NOT NULL
            GROUP BY parent_comment_id
        ) a ON r.comment_id = a.parent_comment_id
        WHERE r.recruit_id = #{recruit_id} AND r.parent_comment_id IS NULL
        ORDER BY r.comment_id DESC
        OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
    </select>

    <delete id="deleteReply" parameterType="map">
        DELETE FROM comment_mercenary
        WHERE comment_id = #{comment_id} OR parent_comment_id = #{comment_id}
    </delete>

    <select id="listReplyAnswer" parameterType="map" resultType="com.fl.model.MercenaryReplyDTO">
        SELECT r.comment_id, r.recruit_id, r.member_code, m.member_name, 
               r.content, r.created_at, r.parent_comment_id
        FROM comment_mercenary r
        JOIN MEMBER m ON r.member_code = m.member_code
        WHERE r.parent_comment_id = #{parent_comment_id}
        ORDER BY r.comment_id DESC
    </select>
    
    <update id="updateHitCount" parameterType="long">
    UPDATE MERCENARY_POST
    SET view_count = view_count + 1 
    WHERE recruit_id = #{recruit_id}
	</update>
    
    <select id="getUserTeamLevel" parameterType="map" resultType="int">
    SELECT NVL(role_level, 1)
    FROM member_team
    WHERE member_code = #{member_code} AND team_code = #{team_code}
</select>

<select id="listTop3" resultType="com.fl.model.MercenaryDTO">
    SELECT * FROM (
        SELECT p.recruit_id, p.title, p.view_count, p.category, 
               TO_CHAR(p.created_at, 'YYYY-MM-DD') created_at, 
               m.member_name, t.team_name  -- team_name 추가
        FROM MERCENARY_POST p
        JOIN MEMBER m ON p.member_code = m.member_code
        LEFT JOIN TEAM t ON p.team_code = t.team_code -- LEFT JOIN 추가
        ORDER BY p.view_count DESC
    ) WHERE ROWNUM &lt;= 3
</select>
    
</mapper>